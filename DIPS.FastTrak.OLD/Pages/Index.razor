@page "/"
@using DIPS.FastTrak.Components
@using DIPS.FastTrak.Models
@using System.Collections
@inject CRFContext CRFContext

<div id="layout" style="display: flex; height: 100%">

    <div style="width: 260px; min-width: 200px">
        <div class="dock-panel" style="min-height: 300px; background: #FFF">
            <HeaderPanel>
                <Header>Skjemaer</Header>
                <ChildContent>
                    <Toolbar>
                        <ToolButton @bind-IsChecked="@IsFormsGrouped" AutoCheck="true">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <path d="M12,-0c-6.627,-0 -12,5.373 -12,12c0,6.627 5.373,12 12,12c6.627,-0 12,-5.373 12,-12c-0,-6.627 -5.373,-12 -12,-12Zm1.924,19.063l-3.731,-0l-0,-8.756l3.731,0l-0,8.756Zm-1.866,-10.507c-1.112,0 -2.013,-0.901 -2.013,-2.013c-0,-1.112 0.901,-2.014 2.013,-2.014c1.112,0 2.014,0.902 2.014,2.014c-0,1.112 -0.902,2.013 -2.014,2.013Z" style="fill:#444;fill-rule:nonzero;" />
                            </svg>
                        </ToolButton>
                    </Toolbar>

                </ChildContent>
            </HeaderPanel>
        </div>
        <Splitter ShowThumb="true" />
        <HeaderPanel>
            <Header>Påminnelser</Header>
            <ChildContent>
                <Toolbar>
                    <ToolButton AutoCheck="true" CSSClass="InfoIcon" ToolTip="Info">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M12,-0c-6.627,-0 -12,5.373 -12,12c0,6.627 5.373,12 12,12c6.627,-0 12,-5.373 12,-12c-0,-6.627 -5.373,-12 -12,-12Zm1.924,19.063l-3.731,-0l-0,-8.756l3.731,0l-0,8.756Zm-1.866,-10.507c-1.112,0 -2.013,-0.901 -2.013,-2.013c-0,-1.112 0.901,-2.014 2.013,-2.014c1.112,0 2.014,0.902 2.014,2.014c-0,1.112 -0.902,2.013 -2.014,2.013Z" />
                        </svg>
                    </ToolButton>
                    <ToolButton AutoCheck="true" CSSClass="AlertIcon">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M-12,-0c-6.627,-0 -12,5.373 -12,12c0,6.627 5.373,12 12,12c6.627,-0 12,-5.373 12,-12c-0,-6.627 -5.373,-12 -12,-12Zm1.924,19.063l-3.731,-0l-0,-8.756l3.731,0l-0,8.756Zm-1.866,-10.507c-1.112,0 -2.013,-0.901 -2.013,-2.013c-0,-1.112 0.901,-2.014 2.013,-2.014c1.112,0 2.014,0.902 2.014,2.014c-0,1.112 -0.902,2.013 -2.014,2.013Z" style="fill:#444;fill-rule:nonzero;" />
                            <path d="M23.24,23.186l-22.48,0c-1.013,-1.013 -1.013,-2.655 -0,-3.668l9.711,-17.944c1.013,-1.013 2.656,-1.013 3.669,-0l9.1,17.944c1.013,1.013 1.013,2.655 0,3.668Zm-13.402,-16.212l1.081,8.862l2.162,0l1.081,-8.862l-4.324,-0Zm2.162,10.159c-0.955,0 -1.729,0.775 -1.729,1.73c-0,0.955 0.774,1.729 1.729,1.729c0.955,-0 1.729,-0.774 1.729,-1.729c0,-0.955 -0.774,-1.73 -1.729,-1.73Z" />
                        </svg>
                    </ToolButton>
                    <ToolButton AutoCheck="true">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M-0.76,23.186l-22.48,0c-1.013,-1.013 -1.013,-2.655 -0,-3.668l9.711,-17.944c1.013,-1.013 2.656,-1.013 3.669,-0l9.1,17.944c1.013,1.013 1.013,2.655 0,3.668Zm-13.402,-16.212l1.081,8.862l2.162,0l1.081,-8.862l-4.324,-0Zm2.162,10.159c-0.955,0 -1.729,0.775 -1.729,1.73c-0,0.955 0.774,1.729 1.729,1.729c0.955,-0 1.729,-0.774 1.729,-1.729c0,-0.955 -0.774,-1.73 -1.729,-1.73Z" style="fill:#444;fill-rule:nonzero;" />
                            <path d="M12,-0c6.627,-0 12,5.372 12,12c-0,6.627 -5.373,12 -12,12c-6.627,-0 -12,-5.373 -12,-12c-0,-6.628 5.373,-12 12,-12Zm-2.5,4.25l1.25,10.25l2.5,-0l1.25,-10.25l-5,-0Zm2.5,11.75c-1.105,-0 -2,0.895 -2,2c-0,1.104 0.895,2 2,2c1.105,-0 2,-0.896 2,-2c0,-1.105 -0.895,-2 -2,-2Z" style="fill:#444;fill-rule:nonzero;" />
                        </svg>
                    </ToolButton>
                    <ToolDivider />
                    <ToolButton>
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M-12,-0c6.627,-0 12,5.372 12,12c-0,6.627 -5.373,12 -12,12c-6.627,-0 -12,-5.373 -12,-12c-0,-6.628 5.373,-12 12,-12Zm-2.5,4.25l1.25,10.25l2.5,-0l1.25,-10.25l-5,-0Zm2.5,11.75c-1.105,-0 -2,0.895 -2,2c-0,1.104 0.895,2 2,2c1.105,-0 2,-0.896 2,-2c0,-1.105 -0.895,-2 -2,-2Z" style="fill:#444;fill-rule:nonzero;" />
                            <path d="M12,1.846c2.91,0 5.533,1.224 7.385,3.185l-0,-5.031l2.769,2.769l-0,7.385l-7.385,-0l-2.769,-2.769l5.16,-0c-1.267,-1.417 -3.11,-2.308 -5.16,-2.308c-3.51,-0 -6.411,2.613 -6.862,6l-3.25,-0c0.466,-5.175 4.815,-9.231 10.112,-9.231Zm0,17.077c3.511,0 6.411,-2.613 6.862,-6l3.251,0c-0.467,5.175 -4.816,9.231 -10.113,9.231c-2.91,-0 -5.533,-1.224 -7.385,-3.185l0,5.031l-2.769,-2.769l0,-7.385l7.385,0l2.769,2.769l-5.16,0c1.267,1.417 3.11,2.308 5.16,2.308Z" style="fill:#444;fill-rule:nonzero;" />
                        </svg>
                    </ToolButton>
                </Toolbar>
                <hr />

            </ChildContent>
        </HeaderPanel>
    </div>

    <Splitter Orientation="Orientation.Vertical" ShowThumb="true" />

    <!-- Main area -->
    <div style="background: #efefef; flex: 1">

    </div>

    <div class="dock-panel">
        <HeaderPanel>
            <Header>Diagnoser</Header>
            <ChildContent>
            </ChildContent>
        </HeaderPanel>
        <Splitter ShowThumb="true" />
        <HeaderPanel>
            <Header>Legemidler</Header>
        </HeaderPanel>
        <Splitter ShowThumb="true" />
        <HeaderPanel>
            <Header>Kritisk informasjon</Header>
        </HeaderPanel>
    </div>
</div>

@code {
    private bool _isFormsGrouped = true;

    public bool IsFormsGrouped
    {
        get => _isFormsGrouped;
        set
        {
            if (value != _isFormsGrouped)
            {
                _isFormsGrouped = value;
                if (_isFormsGrouped)
                {
                    Forms = GroupedForms;
                }
                else
                {
                    Forms = ClinForms;
                }
            }
        }
    }

    [Parameter]
    public IEnumerable? Forms { get; set; }

    [Parameter]
    public List<Alert> Alerts { get; set; } = new();

    public List<ClinForm> ClinForms { get; set; } = new List<ClinForm>();

    private IEnumerable<IGrouping<string, ClinForm>>? GroupedForms;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        CRFContext.ActivateStudyCase(new StudyCase(new Person(), new Study()));

        DateTime today = DateTime.Today;
        DateTime thisWeekStart = today.AddDays(-(int)today.DayOfWeek);
        DateTime thisWeekEnd = thisWeekStart.AddDays(6);

        // Calculate the start and end dates for "last week"
        DateTime lastWeekStart = thisWeekStart.AddDays(-7);
        DateTime lastWeekEnd = thisWeekEnd.AddDays(-7); 

        ClinForms.Add(new ClinForm(new MetaForm(977, "GBD_INSULIN", "Poliklinisk kontroll"), DateTime.Today, ClinFormStatus.Empty));
        ClinForms.Add(new ClinForm(new MetaForm(977, "GBD_INSULIN", "Poliklinisk kontroll"), DateTime.Today, ClinFormStatus.Started));
        ClinForms.Add(new ClinForm(new MetaForm(977, "GBD_INSULIN", "Fotstatus"), DateTime.Today, ClinFormStatus.Signed));
        ClinForms.Add(new ClinForm(new MetaForm(2, "GBD_NOTAT_SPL", "Notat sykepleier"), DateTime.Today.AddDays(-2), ClinFormStatus.Started));
        ClinForms.Add(new ClinForm(new MetaForm(3, "GBD_INSULIN", "baz ba"), DateTime.Today.AddDays(-6), ClinFormStatus.Empty));
        ClinForms.Add(new ClinForm(new MetaForm(3, "GBD_INSULIN", "baz ba"), DateTime.Today.AddDays(-8), ClinFormStatus.Empty));

        GroupedForms = ClinForms.GroupBy(form =>
        {
            if (form.EventTime >= thisWeekStart && form.EventTime <= thisWeekEnd)
                return "Nylig";
            else if (form.EventTime >= lastWeekStart && form.EventTime <= lastWeekEnd)
                return "Forige uke";
            else
                return "Eldre";
        });

        Forms = GroupedForms;

        Alerts.Add(new Alert { Title = "Interaksjondata", Text = "bla bla bla" });
        Alerts.Add(new Alert { Title = "Parokseting - Warfarin", Text = "bla bla bla" });
    }
}